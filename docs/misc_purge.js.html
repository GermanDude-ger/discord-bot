<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: misc/purge.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: misc/purge.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Promise = require("promise")
const Command = require("discord.js-commando").Command

module.exports = class PurgeCommand extends Command {
	constructor(client) {
		super(client, {
			name: 'purge',
			group: 'util',
			memberName: 'purge',
			description: 'Purge messages from a channel',
			clientPermissions: ['MANAGE_MESSAGES'],
			userPermissions: ['MANAGE_MESSAGES'],
			args: [
				{
					key: 'purge',
					label: 'Purge',
					prompt: 'Number of Messages to Purge',
					type: 'integer',
					min: 1,
					default: 1
				},
			]
		})
	}

	/**
	 * @param {CommandMessage} msg The incoming message.
	 * @param {Object|string|Array&lt;string>} args The command arguments.
	 * @param {boolean} _ If the incoming message is from a pattern match.
	 * @returns {Promise&lt;Message>}
	 */
	async run(msg, args, _){return do_purge(msg, msg.id, args.purge, 0)}
}

function purge_messages(chnl, before, max){
	console.log("running purge of " + max + " prior to " + before)
	let count = 0
	let pre_count = 0

	return new Promise((suc, fail) => {
		chnl.fetchMessages({limit: max, before: before})
			.then((msgs) => {
				pre_count = msgs.keyArray().length
				before = msgs.reduce((t, v) => {return Math.min(t, v.id)}, before)
				msgs.filter((v) => {return !v.pinned}).map((v) => v.delete())
				count = msgs.keyArray().length

				return Promise.all(msgs)
			})
			.then(() => {
				suc([count, pre_count, before])
			})
			.catch((err) => {fail(err)})
	})
}

function do_purge(msg, before, left, done){
	function decide(data){
		let [deleted, unfiltered, id] = data
		left = left - deleted

		if (deleted === 0 &amp;&amp; unfiltered === 0){
			return msg.reply(`deleted ${done + deleted} messages.`)
		} else if (left > 0){
			return do_purge(msg, id, left, done + deleted)
		} else {
			return msg.reply(`deleted ${done + deleted} messages.`)
		}
	}

	return purge_messages(msg.channel, before, Math.min(left, 100)).then(decide)
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 21 2019 09:19:20 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
